<div class="exhibitions-container">
  @if (currentMode() === 'list') {
    <div class="header">
      <h1>Gestion des expositions</h1>
      <button mat-raised-button color="primary" (click)="showCreateForm()">
        <mat-icon>add</mat-icon>
        Créer une exposition
      </button>
    </div>

    <mat-card>
      <mat-card-content>
        @if (exhibitions().length > 0) {
          <div class="exhibitions-list">
            @for (exhibition of exhibitions(); track exhibition.id) {
              <div class="exhibition-item">
                <div class="exhibition-image">
                  @if (exhibition.imageUrl) {
                    <img [src]="exhibition.imageUrl" [alt]="exhibition.title">
                  } @else {
                    <div class="no-image">
                      <mat-icon>image</mat-icon>
                    </div>
                  }
                </div>

                <div class="exhibition-content">
                  <h3>{{ exhibition.title }}</h3>
                  <p class="location">{{ exhibition.location }}</p>
                  @if (exhibition.address) {
                    <p class="address">{{ exhibition.address }}</p>
                  }
                  <div class="dates">
                    @if (exhibition.startDate) {
                      <span>Du {{ formatDate(exhibition.startDate) }}</span>
                    }
                    @if (exhibition.endDate) {
                      <span> au {{ formatDate(exhibition.endDate) }}</span>
                    }
                  </div>
                  @if (exhibition.imageUrls && exhibition.imageUrls.length > 0) {
                    <p class="images-count">{{ exhibition.imageUrls.length }} image(s)</p>
                  }
                </div>

                <div class="exhibition-status">
                  <mat-chip [style.background-color]="getStatusColor(exhibition.status)" [style.color]="'white'">
                    {{ getStatusLabel(exhibition.status) }}
                  </mat-chip>
                </div>

                <div class="exhibition-actions">
                  <button mat-icon-button (click)="showEditForm(exhibition)" matTooltip="Modifier">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="deleteExhibition(exhibition.id)" matTooltip="Supprimer">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">
            <mat-icon>event</mat-icon>
            <h3>Aucune exposition</h3>
            <p>Créez votre première exposition pour commencer</p>
            <button mat-raised-button color="primary" (click)="showCreateForm()">
              <mat-icon>add</mat-icon>
              Créer une exposition
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }

  @if (currentMode() === 'create' || currentMode() === 'edit') {
    <div class="header">
      <div class="header-nav">
        <button mat-icon-button (click)="showList()" matTooltip="Retour à la liste">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <h1>{{ currentMode() === 'edit' ? 'Modifier l\'exposition' : 'Créer une exposition' }}</h1>
      </div>
    </div>

    <mat-card class="form-card">
      <mat-card-content>
        <form [formGroup]="exhibitionForm" (ngSubmit)="saveExhibition()">
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Titre</mat-label>
              <input matInput formControlName="title" required>
              @if (exhibitionForm.get('title')?.errors?.['required'] && exhibitionForm.get('title')?.touched) {
                <mat-error>Le titre est obligatoire</mat-error>
              }
              @if (exhibitionForm.get('title')?.errors?.['minlength']) {
                <mat-error>Le titre doit contenir au moins 2 caractères</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Lieu</mat-label>
              <input matInput formControlName="location" required>
              @if (exhibitionForm.get('location')?.errors?.['required'] && exhibitionForm.get('location')?.touched) {
                <mat-error>Le lieu est obligatoire</mat-error>
              }
              @if (exhibitionForm.get('location')?.errors?.['minlength']) {
                <mat-error>Le lieu doit contenir au moins 2 caractères</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Adresse</mat-label>
              <input matInput formControlName="address" placeholder="Rue, numéro, code postal, localité">
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date de début</mat-label>
              <input
                matInput
                [matDatepicker]="startPicker"
                formControlName="startDate"
                placeholder="dd.MM.yyyy"
                required>
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
              @if (exhibitionForm.get('startDate')?.errors?.['required'] && exhibitionForm.get('startDate')?.touched) {
                <mat-error>La date de début est obligatoire</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date de fin</mat-label>
              <input
                matInput
                [matDatepicker]="endPicker"
                formControlName="endDate"
                placeholder="dd.MM.yyyy">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
              @if (exhibitionForm.errors?.['endDateBeforeStarNext'] && exhibitionForm.get('endDate')?.touched) {
                <mat-error>La date de fin ne peut pas être avant la date de début</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-group">
            <label class="image-label">Images de l'exposition</label>
            <app-image-upload
              [currentImages]="uploadedImageUrls()"
              [category]="'exhibitions'"
              [exhibitionSlug]="getExhibitionSlug()"
              [multiple]="true"
              (imagesUploaded)="onImagesUploaded($event)"
              (imageRemoved)="onImageRemoved($event)">
            </app-image-upload>
          </div>

          <div class="form-group">
            <label class="video-label">Vidéos rétrospective</label>
            <input
              type="file"
              #videoInput
              (change)="onVideoSelected($event)"
              accept="video/mp4"
              multiple
              style="display: none;">

            <div class="video-upload-zone" (click)="videoInput.click()">
              <mat-icon>videocam</mat-icon>
              <span>Ajouter des vidéos (MP4)</span>
            </div>

            @if (uploadedVideoUrls().length > 0) {
              <div class="uploaded-videos">
                @for (videoUrl of uploadedVideoUrls(); track videoUrl; let i = $index) {
                  <div class="video-item">
                    <video [src]="videoUrl" class="video-thumbnail"></video>
                    <button
                      type="button"
                      mat-icon-button
                      color="warn"
                      (click)="removeVideo(i); $event.stopPropagation()"
                      class="remove-video-btn">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                }
              </div>
            }

            @if (uploadingVideos()) {
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            }
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="showList()" [disabled]="isSaving()">
              Annuler
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="exhibitionForm.invalid || isSaving()">
              {{ currentMode() === 'edit' ? 'Modifier' : 'Créer' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>

<div class="exhibitions-page">
  <section class="exhibitions-hero">
    <div class="hero-image"></div>
    <div class="hero-content">
      <h1>EXPOSITIONS</h1>
    </div>
  </section>

  <nav class="exhibitions-tabs">
    <div class="tabs-container">
      <button
        class="tab-button"
        [class.active]="activeTab() === 'current'"
        (click)="setActiveTab('current')">
        Actuelles
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'past'"
        (click)="setActiveTab('past')">
        Passées
      </button>
    </div>
  </nav>

  <div class="exhibitions-content">
    @if (activeTab() === 'current') {
      <section class="current-section">
        @if (currentExhibitions().length > 0) {
          <div class="exhibitions-list">
            @for (exhibition of currentExhibitions(); track exhibition.id; let index = $index; let isLast = $last) {
              <article class="exhibition-item" [class.reverse]="index % 2 !== 0">
                <div class="exhibition-gallery" [attr.data-exhibition-id]="exhibition.id">
                  <div class="main-image-container">
                    @if (exhibition.imageUrls && exhibition.imageUrls.length > 1) {
                      <button
                        type="button"
                        class="carousel-btn prev"
                        (click)="previousImage(exhibition.id, exhibition.imageUrls.length)">
                        <mat-icon>chevron_left</mat-icon>
                      </button>
                      <button
                        type="button"
                        class="carousel-btn next"
                        (click)="nextImage(exhibition.id, exhibition.imageUrls.length)">
                        <mat-icon>chevron_right</mat-icon>
                      </button>
                    }

                    <div class="main-image">
                      @if (getUniqueImageUrls(exhibition).length > 0) {
                        <img
                          [src]="getUniqueImageUrls(exhibition)[getSelectedImageIndex(exhibition.id)]"
                          [alt]="exhibition.title"
                          (click)="openImageModal(exhibition.id, getSelectedImageIndex(exhibition.id))">
                      } @else if (exhibition.imageUrl) {
                        <img [src]="exhibition.imageUrl" [alt]="exhibition.title">
                      } @else {
                        <div class="no-image">
                          <span>Aucune image</span>
                        </div>
                      }
                    </div>
                  </div>

                  @if (exhibition.imageUrls && exhibition.imageUrls.length > 1) {
                    <div class="thumbnail-carousel">
                      <div class="thumbnails-container">
                        @for (imageUrl of exhibition.imageUrls; track $index) {
                          <div
                            class="thumbnail"
                            [class.active]="getSelectedImageIndex(exhibition.id) === $index"
                            (click)="selectImage(exhibition.id, $index)">
                            <img [src]="imageUrl" [alt]="exhibition.title">
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>

                <div class="exhibition-content">
                  <h3>{{ exhibition.title }}</h3>
                  <p class="exhibition-dates">{{ formatDateBlock(exhibition.startDate, exhibition.endDate) }}</p>

                  @if (exhibition.location) {
                    <p class="location">{{ exhibition.location }}</p>
                  }

                  @if (exhibition.address) {
                    <p class="address clickable" (click)="onShowOnMap(exhibition)">
                      {{ exhibition.address }}
                    </p>
                  }

                  @if (exhibition.description) {
                    <p class="description">{{ exhibition.description }}</p>
                  }

                  @if (exhibition.credits) {
                    <p class="credits">Crédits: {{ exhibition.credits }}</p>
                  }

                  @if (exhibition.websiteUrl) {
                    <p class="website">
                      Site web de l'exposition: <a [href]="exhibition.websiteUrl" target="_blank" rel="noopener noreferrer">{{ exhibition.websiteUrl }}</a>
                    </p>
                  }

                  <div class="action-buttons">
                    <div class="vernissage-button-container">
                      <button
                        mat-raised-button
                        color="primary"
                        [disabled]="isVernissageRegistrationDisabled(exhibition)"
                        [matTooltip]="isVernissageRegistrationDisabled(exhibition) ? 'L\'exposition est actuellement en cours. Il n\'est plus possible de s\'inscrire au vernissage.' : ''"
                        matTooltipPosition="above"
                        (click)="onVernissageRegistration(exhibition)">
                        S'inscrire au vernissage
                      </button>
                      @if (isVernissageRegistrationDisabled(exhibition)) {
                        <small class="disabled-info">
                          L'exposition est actuellement en cours. Il n'est plus possible de s'inscrire au vernissage.
                        </small>
                      }
                    </div>
                    <button mat-stroked-button (click)="onShowOnMap(exhibition)">
                      Où se rendre
                    </button>
                  </div>
                </div>
              </article>

              @if (!isLast) {
                <hr class="exhibition-separator">
              }
            }
          </div>
        } @else {
          <div class="empty-state">
            <h3>Aucune exposition en cours</h3>
            <p>Consultez les expositions passées ou revenez bientôt</p>
          </div>
        }
      </section>
    }

    @if (activeTab() === 'past') {
      <section class="past-section">
        @if (pastExhibitions().length > 0) {
          <div class="exhibitions-list">
            @for (exhibition of pastExhibitions(); track exhibition.id; let index = $index; let isLast = $last) {
              <article class="exhibition-item" [class.reverse]="index % 2 !== 0">
                <div class="exhibition-gallery" [attr.data-exhibition-id]="exhibition.id">
                  <div class="main-image-container">
                    @if (exhibition.videoUrls && exhibition.videoUrls.length > 0) {
                      @if (getTotalMediaCount(exhibition) > 1) {
                        <button
                          type="button"
                          class="carousel-btn prev"
                          (click)="previousImage(exhibition.id, getTotalMediaCount(exhibition))">
                          <mat-icon>chevron_left</mat-icon>
                        </button>
                        <button
                          type="button"
                          class="carousel-btn next"
                          (click)="nextImage(exhibition.id, getTotalMediaCount(exhibition))">
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                      }
                    } @else if (exhibition.imageUrls && exhibition.imageUrls.length > 1) {
                      <button
                        type="button"
                        class="carousel-btn prev"
                        (click)="previousImage(exhibition.id, exhibition.imageUrls.length)">
                        <mat-icon>chevron_left</mat-icon>
                      </button>
                      <button
                        type="button"
                        class="carousel-btn next"
                        (click)="nextImage(exhibition.id, exhibition.imageUrls.length)">
                        <mat-icon>chevron_right</mat-icon>
                      </button>
                    }

                    <div class="main-image">
                      @if (exhibition.videoUrls && exhibition.videoUrls.length > 0) {
                        @if (isVideoAtCurrentIndex(exhibition, getSelectedImageIndex(exhibition.id))) {
                          <video
                            [src]="getCurrentMediaUrl(exhibition, getSelectedImageIndex(exhibition.id))"
                            controls
                            controlsList="nodownload"
                            class="main-video">
                            Votre navigateur ne supporte pas la lecture de vidéos.
                          </video>
                        } @else {
                          <img
                            [src]="getCurrentMediaUrl(exhibition, getSelectedImageIndex(exhibition.id))"
                            [alt]="exhibition.title"
                            (click)="openImageModal(exhibition.id, getSelectedImageIndex(exhibition.id))">
                        }
                      } @else if (exhibition.imageUrls && exhibition.imageUrls.length > 0) {
                        <img
                          [src]="exhibition.imageUrls[getSelectedImageIndex(exhibition.id)]"
                          [alt]="exhibition.title"
                          (click)="openImageModal(exhibition.id, getSelectedImageIndex(exhibition.id))">
                      } @else if (exhibition.imageUrl) {
                        <img [src]="exhibition.imageUrl" [alt]="exhibition.title">
                      } @else {
                        <div class="no-image">
                          <span>Aucune image</span>
                        </div>
                      }
                    </div>
                  </div>

                  @if (exhibition.videoUrls && exhibition.videoUrls.length > 0) {
                    @if (getTotalMediaCount(exhibition) > 1) {
                      <div class="thumbnail-carousel">
                        <div class="thumbnails-container">
                          @for (mediaUrl of getAllMediaUrls(exhibition); track $index) {
                            <div
                              class="thumbnail"
                              [class.active]="getSelectedImageIndex(exhibition.id) === $index"
                              [class.video-thumbnail]="isVideoUrl(mediaUrl)"
                              (click)="selectImage(exhibition.id, $index)">
                              @if (isVideoUrl(mediaUrl)) {
                                <div class="video-thumbnail-overlay">
                                  <mat-icon>play_circle</mat-icon>
                                </div>
                                <video [src]="mediaUrl" class="thumbnail-video"></video>
                              } @else {
                                <img [src]="mediaUrl" [alt]="exhibition.title">
                              }
                            </div>
                          }
                        </div>
                      </div>
                    }
                  } @else if (exhibition.imageUrls && exhibition.imageUrls.length > 1) {
                    <div class="thumbnail-carousel">
                      <div class="thumbnails-container">
                        @for (imageUrl of exhibition.imageUrls; track $index) {
                          <div
                            class="thumbnail"
                            [class.active]="getSelectedImageIndex(exhibition.id) === $index"
                            (click)="selectImage(exhibition.id, $index)">
                            <img [src]="imageUrl" [alt]="exhibition.title">
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>

                <div class="exhibition-content">
                  <h3>{{ exhibition.title }}</h3>
                  <p class="exhibition-dates">{{ formatDateBlock(exhibition.startDate, exhibition.endDate) }}</p>

                  @if (exhibition.location) {
                    <p class="location">{{ exhibition.location }}</p>
                  }

                  @if (exhibition.address) {
                    <p class="address clickable" (click)="onShowOnMap(exhibition)">
                      {{ exhibition.address }}
                    </p>
                  }

                  @if (exhibition.description) {
                    <p class="description">{{ exhibition.description }}</p>
                  }

                  @if (exhibition.credits) {
                    <p class="credits">Crédits: {{ exhibition.credits }}</p>
                  }

                  @if (exhibition.websiteUrl) {
                    <p class="website">
                      Site web de l'exposition: <a [href]="exhibition.websiteUrl" target="_blank" rel="noopener noreferrer">{{ exhibition.websiteUrl }}</a>
                    </p>
                  }
                </div>
              </article>

              @if (!isLast) {
                <hr class="exhibition-separator">
              }
            }
          </div>
        } @else {
          <div class="empty-state">
            <h3>Aucune exposition passée</h3>
            <p>L'historique des expositions sera bientôt disponible</p>
          </div>
        }
      </section>
    }
  </div>
</div>

@if (showImageModal()) {
  <div class="image-modal" (click)="closeImageModal()">
    <div class="modal-content">
      @if (modalExhibition(); as exhibition) {
        <div class="modal-image-wrapper">
          <img
            [src]="exhibition.imageUrls![modalImageIndex()]"
            [alt]="exhibition.title"
            class="modal-image"
            (click)="$event.stopPropagation()">

          <button type="button" class="modal-close" (click)="closeImageModal()">
            <mat-icon>close</mat-icon>
          </button>

          @if (exhibition.imageUrls!.length > 1) {
            <button
              type="button"
              class="modal-prev"
              (click)="previousModalImage($event, exhibition.imageUrls!.length)">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button
              type="button"
              class="modal-next"
              (click)="nextModalImage($event, exhibition.imageUrls!.length)">
              <mat-icon>chevron_right</mat-icon>
            </button>
          }
        </div>
      }
    </div>
  </div>
}
